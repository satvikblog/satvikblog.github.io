[{"id":"cea3414c622367bb74c9fe88dd9fca82","title":"Nmap Advanced Port Scans","content":"Cheatsheet of the commands used in this room\n\n\nPort Scan Type\nExample Command\n\n\n\nTCP Null Scan\nsudo nmap -sN 10.10.214.83\n\n\nTCP FIN Scan\nsudo nmap -sF 10.10.214.83\n\n\nTCP Xmas Scan\nsudo nmap -sX 10.10.214.83\n\n\nTCP Maimon Scan\nsudo nmap -sM 10.10.214.83\n\n\nTCP ACK Scan\nsudo nmap -sA 10.10.214.83\n\n\nTCP Window Scan\nsudo nmap -sW 10.10.214.83\n\n\nCustom TCP Scan\nsudo nmap –scanflags URGACKPSHRSTSYNFIN 10.10.214.83\n\n\nSpoofed Source IP\nsudo nmap -S SPOOFED_IP 10.10.214.83\n\n\nSpoofed MAC Address\n–spoof-mac SPOOFED_MAC\n\n\nDecoy Scan\nnmap -D DECOY_IP,ME 10.10.214.83\n\n\nIdle (Zombie) Scan\nsudo nmap -sI ZOMBIE_IP 10.10.214.83\n\n\nFragment IP data into 8 bytes\n-f\n\n\nFragment IP data into 16 bytes\n-ff\n\n\n\n\n\nOption\nPurpose\n\n\n\n–source-port PORT_NUM\nspecify source port number\n\n\n–data-length NUM\nappend random data to reach given length\n\n\nThese scan types rely on setting TCP flags in unexpected ways to prompt ports for a reply. Null, FIN, and Xmas scans provoke a response from closed ports, while Maimon, ACK, and Window scans provoke a response from open and closed ports.\n\n\n\nOption\nPurpose\n\n\n\n–reason\nexplains how Nmap made its conclusion\n\n\n-v\nverbose\n\n\n-vv\nvery verbose\n\n\n-d\ndebugging\n\n\n-dd\nmore details for debugging\n\n\n\nIntroductionThis room is the third in the Nmap series (part of the Introduction to Network Security module). In the first two rooms, we learned about live host discovery and basic port scans.\n\nNmap Live Host Discovery\nNmap Basic Port Scans\nNmap Advanced Port Scans\nNmap Post Port ScansIn Nmap Basic Port Scans, we covered TCP flags and reviewed the TCP 3-way handshake. To initiate a connection, TCP requires the first packet to have the SYN flag set. Consequently, we can tell if a TCP port is open based on the response we receive.\n\nSecurity researchers and hackers contemplated the TCP flags, shown in the figure below and explained in the previous room, and started to experiment. They wanted to know what would happen if we send a TCP packet, which is not part of any ongoing TCP connection, with one or more flags set.\n\nFor instance, an ACK flag is set when you want to acknowledge received data. An ACK scan is like trying to acknowledge data that was neither sent nor received in the first place. Consider this simple analogy, someone coming to you out of nowhere to tell you, “yes, I hear you, please continue.” when you haven’t said anything.\nThis room explains advanced types of scans and scan options. Some of these scan types can be useful against specific systems, while others are useful in particular network setups. We will cover the following types of port scans:\nNull ScanFIN ScanXmas ScanMaimon ScanACK ScanWindow ScanCustom Scan\nMoreover, we will cover the following:\nSpoofing IPSpoofing MACDecoy ScanFragmented PacketsIdle&#x2F;Zombie ScanWe will discuss options and techniques to evade firewalls and IDS systems. We also cover options to get more verbose details from Nmap.\nQuestions &amp; Answers in the TaskLaunch the AttackBox by using the Start AttackBox button and get ready to experiment with different types of Nmap scans against different virtual machines.Answer : Click Submit\nTASK-2 TCP Null Scan, FIN Scan, and Xmas ScanLet’s start with the following three types of scans:\n\nNull Scan\nFIN Scan\nXmas Scan\n\nNull ScanThe null scan does not set any flag; all six flag bits are set to zero. You can choose this scan using the -sN option. A TCP packet with no flags set will not trigger any response when it reaches an open port, as shown in the figure below. Therefore, from Nmap’s perspective, a lack of reply in a null scan indicates that either the port is open or a firewall is blocking the packet.\n\nHowever, we expect the target server to respond with an RST packet if the port is closed. Consequently, we can use the lack of RST response to figure out the ports that are not closed: open or filtered.\n\nBelow is an example of a null scan against a Linux server. The null scan we carried out has successfully identified the six open ports on the target system. Because the null scan relies on the lack of a response to infer that the port is not closed, it cannot indicate with certainty that these ports are open; there is a possibility that the ports are not responding due to a firewall rule.\nPentester Terminal\n12345678910111213141516pentester@TryHackMe$ sudo nmap -sN MACHINE_IPStarting Nmap 7.60 ( https://nmap.org ) at 2021-08-30 10:30 BSTNmap scan report for MACHINE_IPHost is up (0.00066s latency).Not shown: 994 closed portsPORT    STATE         SERVICE22/tcp  open|filtered ssh25/tcp  open|filtered smtp80/tcp  open|filtered http110/tcp open|filtered pop3111/tcp open|filtered rpcbind143/tcp open|filtered imapMAC Address: 02:45:BF:8A:2D:6B (Unknown)Nmap done: 1 IP address (1 host up) scanned in 96.50 seconds\nNote that many Nmap options require root privileges. Unless you are running Nmap as root, you need to use sudo as in the example above using the -sN option.\nFIN ScanThe FIN scan sends a TCP packet with the FIN flag set. You can choose this scan type using the -sF option. Similarly, no response will be sent if the TCP port is open. Again, Nmap cannot be sure if the port is open or if a firewall is blocking the traffic related to this TCP port.\n\nHowever, the target system should respond with an RST if the port is closed. Consequently, we will be able to know which ports are closed and use this knowledge to infer the ports that are open or filtered. It’s worth noting some firewalls will ‘silently’ drop the traffic without sending an RST.\n\nBelow is an example of a FIN scan against a Linux server. The result is quite similar to the result we obtained earlier using a null scan.\nPentester Terminal\n12345678910111213141516pentester@TryHackMe$ sudo nmap -sF MACHINE_IPStarting Nmap 7.60 ( https://nmap.org ) at 2021-08-30 10:32 BSTNmap scan report for MACHINE_IPHost is up (0.0018s latency).Not shown: 994 closed portsPORT    STATE         SERVICE22/tcp  open|filtered ssh25/tcp  open|filtered smtp80/tcp  open|filtered http110/tcp open|filtered pop3111/tcp open|filtered rpcbind143/tcp open|filtered imapMAC Address: 02:45:BF:8A:2D:6B (Unknown)Nmap done: 1 IP address (1 host up) scanned in 96.52 seconds\n\nXmas ScanThe Xmas scan gets its name after Christmas tree lights. An Xmas scan sets the FIN, PSH, and URG flags simultaneously. You can select Xmas scan with the option -sX.\nLike the Null scan and FIN scan, if an RST packet is received, it means that the port is closed. Otherwise, it will be reported as open|filtered.\nThe following two figures show the case when the TCP port is open and the case when the TCP port is closed.\n\nThe console output below shows an example of a Xmas scan against a Linux server. The obtained results are pretty similar to that of the null scan and the FIN scan.\nPentester Terminal\n1234567891011121314151617pentester@TryHackMe$ sudo nmap -sX MACHINE_IPStarting Nmap 7.60 ( https://nmap.org ) at 2021-08-30 10:34 BSTNmap scan report for MACHINE_IPHost is up (0.00087s latency).Not shown: 994 closed portsPORT    STATE         SERVICE22/tcp  open|filtered ssh25/tcp  open|filtered smtp80/tcp  open|filtered http110/tcp open|filtered pop3111/tcp open|filtered rpcbind143/tcp open|filtered imapMAC Address: 02:45:BF:8A:2D:6B (Unknown)Nmap done: 1 IP address (1 host up) scanned in 84.85 seconds\nOne scenario where these three scan types can be efficient is when scanning a target behind a stateless (non-stateful) firewall. A stateless firewall will check if the incoming packet has the SYN flag set to detect a connection attempt. Using a flag combination that does not match the SYN packet makes it possible to deceive the firewall and reach the system behind it. However, a stateful firewall will practically block all such crafted packets and render this kind of scan useless.\nQuestions and answers of the task\nTASK 3 - TCP  Maimon ScanUriel Maimon first described this scan in 1996. In this scan, the FIN and ACK bits are set. The target should send an RST packet as a response. However, certain BSD-derived systems drop the packet if it is an open port exposing the open ports. This scan won’t work on most targets encountered in modern networks; however, we include it in this room to better understand the port scanning mechanism and the hacking mindset. To select this scan type, use the -sM option.\nMost target systems respond with an RST packet regardless of whether the TCP port is open. In such a case, we won’t be able to discover the open ports. The figure below shows the expected behaviour in the cases of both open and closed TCP ports.\n\nThe console output below is an example of a TCP Maimon scan against a Linux server. As mentioned, because open ports and closed ports are behaving the same way, the Maimon scan could not discover any open ports on the target system.\nPentester Terminal\n123456789pentester@TryHackMe$ sudo nmap -sM 10.10.252.27Starting Nmap 7.60 ( https://nmap.org ) at 2021-08-30 10:36 BSTNmap scan report for ip-10-10-252-27.eu-west-1.compute.internal (10.10.252.27)Host is up (0.00095s latency).All 1000 scanned ports on ip-10-10-252-27.eu-west-1.compute.internal (10.10.252.27) are closedMAC Address: 02:45:BF:8A:2D:6B (Unknown)Nmap done: 1 IP address (1 host up) scanned in 1.61 seconds\nThis type of scan is not the first scan one would pick to discover a system; however, it is important to know about it as you don’t know when it could come in handy.\nQuestions&amp;Answers of the task\nTASK 4 - TCP ACK, Window, and Custom ScanThis task will cover how to perform a TCP ACK scan, a TCP window scan, and how to create your custom flag scan.\nTCP ACK ScanLet’s start with the TCP ACK scan. As the name implies, an ACK scan will send a TCP packet with the ACK flag set. Use the -sA option to choose this scan. As we show in the figure below, the target would respond to the ACK with RST regardless of the state of the port. This behaviour happens because a TCP packet with the ACK flag set should be sent only in response to a received TCP packet to acknowledge the receipt of some data, unlike our case. Hence, this scan won’t tell us whether the target port is open in a simple setup.\n\nIn the following example, we scanned the target VM before installing a firewall on it. As expected, we couldn’t learn which ports were open.\nPentester Terminal\n123456789pentester@TryHackMe$ sudo nmap -sA MACHINE_IPStarting Nmap 7.60 ( https://nmap.org ) at 2021-08-30 10:37 BSTNmap scan report for MACHINE_IPHost is up (0.0013s latency).All 1000 scanned ports on MACHINE_IP are unfilteredMAC Address: 02:45:BF:8A:2D:6B (Unknown)Nmap done: 1 IP address (1 host up) scanned in 1.68 seconds\nThis kind of scan would be helpful if there is a firewall in front of the target. Consequently, based on which ACK packets resulted in responses, you will learn which ports were not blocked by the firewall. In other words, this type of scan is more suitable to discover firewall rule sets and configuration.\nAfter setting up the target VM MACHINE_IP with a firewall, we repeated the ACK scan. This time, we received some interesting results. As seen in the console output below, we have three ports that aren’t being blocked by the firewall. This result indicates that the firewall is blocking all other ports except for these three ports.\nPentester Terminal\n12345678910111213pentester@TryHackMe$ sudo nmap -sA MACHINE_IPStarting Nmap 7.60 ( https://nmap.org ) at 2021-09-07 11:34 BSTNmap scan report for MACHINE_IPHost is up (0.00046s latency).Not shown: 997 filtered portsPORT    STATE      SERVICE22/tcp  unfiltered ssh25/tcp  unfiltered smtp80/tcp  unfiltered httpMAC Address: 02:78:C0:D0:4E:E9 (Unknown)Nmap done: 1 IP address (1 host up) scanned in 15.45 seconds\n\nWindow ScanAnother similar scan is the TCP window scan. The TCP window scan is almost the same as the ACK scan; however, it examines the TCP Window field of the RST packets returned. On specific systems, this can reveal that the port is open. You can select this scan type with the option -sW. As shown in the figure below, we expect to get an RST packet in reply to our “uninvited” ACK packets, regardless of whether the port is open or closed.\n\nSimilarly, launching a TCP window scan against a Linux system with no firewall will not provide much information. As we can see in the console output below, the results of the window scan against a Linux server with no firewall didn’t give any extra information compared to the ACK scan executed earlier.\nPentester Terminal\n123456789pentester@TryHackMe$ sudo nmap -sW MACHINE_IPStarting Nmap 7.60 ( https://nmap.org ) at 2021-08-30 10:38 BSTNmap scan report for MACHINE_IPHost is up (0.0011s latency).All 1000 scanned ports on ip-10-10-252-27.eu-west-1.compute.internal (10.10.252.27) are closedMAC Address: 02:45:BF:8A:2D:6B (Unknown)Nmap done: 1 IP address (1 host up) scanned in 1.60 seconds\nHowever, as you would expect, if we repeat our TCP window scan against a server behind a firewall, we expect to get more satisfying results. In the console output shown below, the TCP window scan pointed that three ports are detected as closed. (This is in contrast with the ACK scan that labelled the same three ports as unfiltered.) Although we know that these three ports are not closed, we realize they responded differently, indicating that the firewall does not block them.\nPentester Terminal\npentester@TryHackMe$ sudo nmap -sW MACHINE_IP123456789101112Starting Nmap 7.60 ( https://nmap.org ) at 2021-09-07 11:39 BSTNmap scan report for MACHINE_IPHost is up (0.00040s latency).Not shown: 997 filtered portsPORT    STATE  SERVICE22/tcp  closed ssh25/tcp  closed smtp80/tcp  closed httpMAC Address: 02:78:C0:D0:4E:E9 (Unknown)Nmap done: 1 IP address (1 host up) scanned in 14.84 seconds\n\nCustom ScanIf you want to experiment with a new TCP flag combination beyond the built-in TCP scan types, you can do so using –scanflags. For instance, if you want to set SYN, RST, and FIN simultaneously, you can do so using –scanflags RSTSYNFIN. As shown in the figure below, if you develop your custom scan, you need to know how the different ports will behave to interpret the results in different scenarios correctly.\n\nFinally, it is essential to note that the ACK scan and the window scan were very efficient at helping us map out the firewall rules. However, it is vital to remember that just because a firewall is not blocking a specific port, it does not necessarily mean that a service is listening on that port. For example, there is a possibility that the firewall rules need to be updated to reflect recent service changes. Hence, ACK and window scans are exposing the firewall rules, not the services.\nQuestions and Answers of this Task\nTASK 5 Spoofing and DecoysIn some network setups, you will be able to scan a target system using a spoofed IP address and even a spoofed MAC address. Such a scan is only beneficial in a situation where you can guarantee to capture the response. If you try to scan a target from some random network using a spoofed IP address, chances are you won’t have any response routed to you, and the scan results could be unreliable.\nThe following figure shows the attacker launching the command nmap -S SPOOFED_IP MACHINE_IP. Consequently, Nmap will craft all the packets using the provided source IP address SPOOFED_IP. The target machine will respond to the incoming packets sending the replies to the destination IP address SPOOFED_IP. For this scan to work and give accurate results, the attacker needs to monitor the network traffic to analyze the replies.\n\nIn brief, scanning with a spoofed IP address is three steps:\nAttacker sends a packet with a spoofed source IP address to the target machine.Target machine replies to the spoofed IP address as the destination.Attacker captures the replies to figure out open ports.In general, you expect to specify the network interface using -e and to explicitly disable ping scan -Pn. Therefore, instead of nmap -S SPOOFED_IP MACHINE_IP, you will need to issue nmap -e NET_INTERFACE -Pn -S SPOOFED_IP MACHINE_IP to tell Nmap explicitly which network interface to use and not to expect to receive a ping reply. It is worth repeating that this scan will be useless if the attacker system cannot monitor the network for responses.\nWhen you are on the same subnet as the target machine, you would be able to spoof your MAC address as well. You can specify the source MAC address using –spoof-mac SPOOFED_MAC. This address spoofing is only possible if the attacker and the target machine are on the same Ethernet (802.3) network or same WiFi (802.11).\nSpoofing only works in a minimal number of cases where certain conditions are met. Therefore, the attacker might resort to using decoys to make it more challenging to be pinpointed. The concept is simple, make the scan appear to be coming from many IP addresses so that the attacker’s IP address would be lost among them. As we see in the figure below, the scan of the target machine will appear to be coming from 3 different sources, and consequently, the replies will go the decoys as well.\n\nYou can launch a decoy scan by specifying a specific or random IP address after -D. For example, nmap -D 10.10.0.1,10.10.0.2,ME MACHINE_IP will make the scan of MACHINE_IP appear as coming from the IP addresses 10.10.0.1, 10.10.0.2, and then ME to indicate that your IP address should appear in the third order. Another example command would be nmap -D 10.10.0.1,10.10.0.2,RND,RND,ME MACHINE_IP, where the third and fourth source IP addresses are assigned randomly, while the fifth source is going to be the attacker’s IP address. In other words, each time you execute the latter command, you would expect two new random IP addresses to be the third and fourth decoy sources.\nTASK 6 - Fragmented PacketsFirewallA firewall is a piece of software or hardware that permits packets to pass through or blocks them. It functions based on firewall rules, summarized as blocking all traffic with exceptions or allowing all traffic with exceptions. For instance, you might block all traffic to your server except those coming to your web server. A traditional firewall inspects, at least, the IP header and the transport layer header. A more sophisticated firewall would also try to examine the data carried by the transport layer.\nIDSAn intrusion detection system (IDS) inspects network packets for select behavioural patterns or specific content signatures. It raises an alert whenever a malicious rule is met. In addition to the IP header and transport layer header, an IDS would inspect the data contents in the transport layer and check if it matches any malicious patterns. How can you make it less likely for a traditional firewall&#x2F;IDS to detect your Nmap activity? It is not easy to answer this; however, depending on the type of firewall&#x2F;IDS, you might benefit from dividing the packet into smaller packets.\nFragmented PacketsNmap provides the option -f to fragment packets. Once chosen, the IP data will be divided into 8 bytes or less. Adding another -f (-f -f or -ff) will split the data into 16 byte-fragments instead of 8. You can change the default value by using the –mtu; however, you should always choose a multiple of 8.\nTo properly understand fragmentation, we need to look at the IP header in the figure below. It might look complicated at first, but we notice that we know most of its fields. In particular, notice the source address taking 32 bits (4 bytes) on the fourth row, while the destination address is taking another 4 bytes on the fifth row. The data that we will fragment across multiple packets is highlighted in red. To aid in the reassembly on the recipient side, IP uses the identification (ID) and fragment offset, shown on the second row of the figure below.\n\nLet’s compare running sudo nmap -sS -p80 10.20.30.144 and sudo nmap -sS -p80 -f 10.20.30.144. As you know by now, this will use stealth TCP SYN scan on port 80; however, in the second command, we are requesting Nmap to fragment the IP packets.\nIn the first two lines, we can see an ARP query and response. Nmap issued an ARP query because the target is on the same Ethernet. The second two lines show a TCP SYN ping and a reply. The fifth line is the beginning of the port scan; Nmap sends a TCP SYN packet to port 80. In this case, the IP header is 20 bytes, and the TCP header is 24 bytes. Note that the minimum size of the TCP header is 20 bytes.\n\nWith fragmentation requested via -f, the 24 bytes of the TCP header will be divided into multiples of 8 bytes, with the last fragment containing 8 bytes or less of the TCP header. Since 24 is divisible by 8, we got 3 IP fragments; each has 20 bytes of IP header and 8 bytes of TCP header. We can see the three fragments between the fifth and the seventh lines.\n\nNote that if you added -ff (or -f -f), the fragmentation of the data will be multiples of 16. In other words, the 24 bytes of the TCP header, in this case, would be divided over two IP fragments, the first containing 16 bytes and the second containing 8 bytes of the TCP header.\nOn the other hand, if you prefer to increase the size of your packets to make them look innocuous, you can use the option –data-length NUM, where num specifies the number of bytes you want to append to your packets.\nQuestion and Answers of the task\nTASK 7 - Idle &#x2F; Zombie ScanSpoofing the source IP address can be a great approach to scanning stealthily. However, spoofing will only work in specific network setups. It requires you to be in a position where you can monitor the traffic. Considering these limitations, spoofing your IP address can have little use; however, we can give it an upgrade with the idle scan.\nThe idle scan, or zombie scan, requires an idle system connected to the network that you can communicate with. Practically, Nmap will make each probe appear as if coming from the idle (zombie) host, then it will check for indicators whether the idle (zombie) host received any response to the spoofed probe. This is accomplished by checking the IP identification (IP ID) value in the IP header. You can run an idle scan using nmap -sI ZOMBIE_IP MACHINE_IP, where ZOMBIE_IP is the IP address of the idle host (zombie).\nThe idle (zombie) scan requires the following three steps to discover whether a port is open:\nTrigger the idle host to respond so that you can record the current IP ID on the idle host.Send a SYN packet to a TCP port on the target. The packet should be spoofed to appear as if it was coming from the idle host (zombie) IP address.Trigger the idle machine again to respond so that you can compare the new IP ID with the one received earlier.Let’s explain with figures. In the figure below, we have the attacker system probing an idle machine, a multi-function printer. By sending a SYN&#x2F;ACK, it responds with an RST packet containing its newly incremented IP ID.\n\nThe attacker will send a SYN packet to the TCP port they want to check on the target machine in the next step. However, this packet will use the idle host (zombie) IP address as the source. Three scenarios would arise. In the first scenario, shown in the figure below, the TCP port is closed; therefore, the target machine responds to the idle host with an RST packet. The idle host does not respond; hence its IP ID is not incremented.\n\nIn the second scenario, as shown below, the TCP port is open, so the target machine responds with a SYN&#x2F;ACK to the idle host (zombie). The idle host responds to this unexpected packet with an RST packet, thus incrementing its IP ID.\n\nIn the third scenario, the target machine does not respond at all due to firewall rules. This lack of response will lead to the same result as with the closed port; the idle host won’t increase the IP ID.\nFor the final step, the attacker sends another SYN&#x2F;ACK to the idle host. The idle host responds with an RST packet, incrementing the IP ID by one again. The attacker needs to compare the IP ID of the RST packet received in the first step with the IP ID of the RST packet received in this third step. If the difference is 1, it means the port on the target machine was closed or filtered. However, if the difference is 2, it means that the port on the target was open.\nIt is worth repeating that this scan is called an idle scan because choosing an idle host is indispensable for the accuracy of the scan. If the “idle host” is busy, all the returned IP IDs would be useless.\nQuestions and answers of this task\nTASK 8 - Getting more dteailsYou might consider adding –reason if you want Nmap to provide more details regarding its reasoning and conclusions. Consider the two scans below to the system; however, the latter adds –reason.\nPentester Terminal\n12345678910111213141516pentester@TryHackMe$ sudo nmap -sS 10.10.252.27Starting Nmap 7.60 ( https://nmap.org ) at 2021-08-30 10:39 BSTNmap scan report for ip-10-10-252-27.eu-west-1.compute.internal (10.10.252.27)Host is up (0.0020s latency).Not shown: 994 closed portsPORT    STATE SERVICE22/tcp  open  ssh25/tcp  open  smtp80/tcp  open  http110/tcp open  pop3111/tcp open  rpcbind143/tcp open  imapMAC Address: 02:45:BF:8A:2D:6B (Unknown)Nmap done: 1 IP address (1 host up) scanned in 1.60 seconds\nPentester Terminal\npentester@TryHackMe$ sudo nmap -sS --reason 10.10.252.2712345678910111213141516Starting Nmap 7.60 ( https://nmap.org ) at 2021-08-30 10:40 BSTNmap scan report for ip-10-10-252-27.eu-west-1.compute.internal (10.10.252.27)Host is up, received arp-response (0.0020s latency).Not shown: 994 closed portsReason: 994 resetsPORT    STATE SERVICE REASON22/tcp  open  ssh     syn-ack ttl 6425/tcp  open  smtp    syn-ack ttl 6480/tcp  open  http    syn-ack ttl 64110/tcp open  pop3    syn-ack ttl 64111/tcp open  rpcbind syn-ack ttl 64143/tcp open  imap    syn-ack ttl 64MAC Address: 02:45:BF:8A:2D:6B (Unknown)Nmap done: 1 IP address (1 host up) scanned in 1.59 seconds\nProviding the –reason flag gives us the explicit reason why Nmap concluded that the system is up or a particular port is open. In this console output above, we can see that this system is considered online because Nmap “received arp-response.” On the other hand, we know that the SSH port is deemed to be open because Nmap received a “syn-ack” packet back.\nFor more detailed output, you can consider using -v for verbose output or -vv for even more verbosity.\nPentester Terminal12345678910111213141516171819202122232425262728293031323334pentester@TryHackMe$ sudo nmap -sS -vv 10.10.252.27Starting Nmap 7.60 ( https://nmap.org ) at 2021-08-30 10:41 BSTInitiating ARP Ping Scan at 10:41Scanning 10.10.252.27 [1 port]Completed ARP Ping Scan at 10:41, 0.22s elapsed (1 total hosts)Initiating Parallel DNS resolution of 1 host. at 10:41Completed Parallel DNS resolution of 1 host. at 10:41, 0.00s elapsedInitiating SYN Stealth Scan at 10:41Scanning ip-10-10-252-27.eu-west-1.compute.internal (10.10.252.27) [1000 ports]Discovered open port 22/tcp on 10.10.252.27Discovered open port 25/tcp on 10.10.252.27Discovered open port 80/tcp on 10.10.252.27Discovered open port 110/tcp on 10.10.252.27Discovered open port 111/tcp on 10.10.252.27Discovered open port 143/tcp on 10.10.252.27Completed SYN Stealth Scan at 10:41, 1.25s elapsed (1000 total ports)Nmap scan report for ip-10-10-252-27.eu-west-1.compute.internal (10.10.252.27)Host is up, received arp-response (0.0019s latency).Scanned at 2021-08-30 10:41:02 BST for 1sNot shown: 994 closed portsReason: 994 resetsPORT    STATE SERVICE REASON22/tcp  open  ssh     syn-ack ttl 6425/tcp  open  smtp    syn-ack ttl 6480/tcp  open  http    syn-ack ttl 64110/tcp open  pop3    syn-ack ttl 64111/tcp open  rpcbind syn-ack ttl 64143/tcp open  imap    syn-ack ttl 64MAC Address: 02:45:BF:8A:2D:6B (Unknown)Read data files from: /usr/bin/../share/nmapNmap done: 1 IP address (1 host up) scanned in 1.59 seconds           Raw packets sent: 1002 (44.072KB) | Rcvd: 1002 (40.092KB)\nIf -vv does not satisfy your curiosity, you can use -d for debugging details or -dd for even more details. You can guarantee that using -d will create an output that extends beyond a single screen.\nQuestions and answers of this task\nSUMMARY\n\n\nPort Scan Type\nExample Command\n\n\n\nTCP Null Scan\nsudo nmap -sN 10.10.214.83\n\n\nTCP FIN Scan\nsudo nmap -sF 10.10.214.83\n\n\nTCP Xmas Scan\nsudo nmap -sX 10.10.214.83\n\n\nTCP Maimon Scan\nsudo nmap -sM 10.10.214.83\n\n\nTCP ACK Scan\nsudo nmap -sA 10.10.214.83\n\n\nTCP Window Scan\nsudo nmap -sW 10.10.214.83\n\n\nCustom TCP Scan\nsudo nmap –scanflags URGACKPSHRSTSYNFIN 10.10.214.83\n\n\nSpoofed Source IP\nsudo nmap -S SPOOFED_IP 10.10.214.83\n\n\nSpoofed MAC Address\n–spoof-mac SPOOFED_MAC\n\n\nDecoy Scan\nnmap -D DECOY_IP,ME 10.10.214.83\n\n\nIdle (Zombie) Scan\nsudo nmap -sI ZOMBIE_IP 10.10.214.83\n\n\nFragment IP data into 8 bytes\n-f\n\n\nFragment IP data into 16 bytes\n-ff\n\n\n\n\n\nOption\nPurpose\n\n\n\n–source-port PORT_NUM\nspecify source port number\n\n\n–data-length NUM\nappend random data to reach given length\n\n\nThese scan types rely on setting TCP flags in unexpected ways to prompt ports for a reply. Null, FIN, and Xmas scans provoke a response from closed ports, while Maimon, ACK, and Window scans provoke a response from open and closed ports.\n\n\n\nOption\nPurpose\n\n\n\n–reason\nexplains how Nmap made its conclusion\n\n\n-v\nverbose\n\n\n-vv\nvery verbose\n\n\n-d\ndebugging\n\n\n-dd\nmore details for debugging\n\n\n\n","slug":"Nmap-Advanced-Port-Scans","date":"2024-05-16T15:27:44.000Z","categories_index":"cybersecurity,THM,NMAP","tags_index":"tryhackme,nmap,information-gathering","author_index":"Satvik"},{"id":"2bcf8d570917965c65fd2618756df225","title":"Live Host Discovery - NMAP","content":"IntroductionWe can find live hosts on a network by using any of the 3 scans that are named below:\n\nARP scan: This scan uses ARP requests to discover live hosts\nICMP scan: This scan uses ICMP requests to identify live hosts\nTCP&#x2F;UDP ping scan: This scan sends packets to TCP ports and UDP ports to determine live hosts.\n\nA Nmap scan usually goes through the steps shown in the figure below, although many are optional and depend on the command-line arguments you provide.\n\n\nTASK 2 - SUBNETWORKSA network segment is a group of computers connected using a shared medium. For instance, the medium can be the Ethernet switch or WiFi access point. In an IP network, a subnetwork is usually the equivalent of one or more network segments connected together and configured to use the same router. The network segment refers to a physical connection, while a subnetwork refers to a logical connection.\nIn the following network diagram, we have four network segments or subnetworks. Generally speaking, your system would be connected to one of these network segments&#x2F;subnetworks. A subnetwork, or simply a subnet, has its own IP address range and is connected to a more extensive network via a router. There might be a firewall enforcing security policies depending on each network.\n\nThe figure above shows two types of subnets:\n\nSubnets with /16, which means that the subnet mask can be written as 255.255.0.0. This subnet can have around 65 thousand hosts.\nSubnets with /24, which indicates that the subnet mask can be expressed as 255.255.255.0. This subnet can have around 250 hosts\n\nIf you are in Network A, you can use ARP only to discover the devices within that subnet (10.1.100.0&#x2F;24). Suppose you are connected to a subnet different from the subnet of the target system(s). In that case, all packets generated by your scanner will be routed via the default gateway (router) to reach the systems on another subnet; however, the ARP queries won’t be routed and hence cannot cross the subnet router. ARP is a link-layer protocol, and ARP packets are bound to their subnet.\nAnswer the questions below\nSend a packet with the following:\n\n\nFrom computer1\nTo computer1 (to indicate it is broadcast)\nPacket Type: “ARP Request”\nData: computer6 (because we are asking for computer6 MAC address using ARP Request)\n\nHow many devices can see the ARP Request?\nAnswer : 4\nDid computer6 receive the ARP Request? (Y&#x2F;N)Answer : N\nSend a packet with the following:\n\n\nFrom computer4\nTo computer4 (to indicate it is broadcast)\nPacket Type: “ARP Request”\nData: computer6 (because we are asking for computer6 MAC address using ARP Request)\n\nHow many devices can see the ARP Request?\nAnswer : 4\nDid computer6 reply to the ARP Request? (Y&#x2F;N)\nAnswer : Y\n\nTASK 3 - Enumerating TargetsWe mentioned the different techniques we can use for scanning in Task 1. Before we explain each in detail and put it into use against a live target, we need to specify the targets we want to scan. Generally speaking, you can provide a list, a range, or a subnet. Examples of target specification are:\n\nlist: MACHINE_IP scanme.nmap.org example.com will scan 3 IP addresses.\nrange: 10.11.12.15-20 will scan 6 IP addresses: 10.11.12.15, **10.11.12.16… and 10.11.12.20.\nsubnet: MACHINE_IP/30 will scan 4 IP addresses.\n\nYou can also provide a file as input for your list of targets, nmap -iL list_of_hosts.txt.\nIf you want to check the list of hosts that Nmap will scan, you can use nmap -sL TARGETS. This option will give you a detailed list of the hosts that Nmap will scan without scanning them; however, Nmap will attempt a reverse-DNS resolution on all the targets to obtain their names. Names might reveal various information to the pentester. (If you don’t want Nmap to the DNS server, you can add -n.)\nLaunch the AttackBox using the Start AttackBox button, open the terminal when the AttackBox is ready, and use Nmap to answer the following.\nQ1 . What is the first IP address Nmap would scan if you provided 10.10.12.13/29 as your target?\nAnswer :we can use the command nmap -sL 10.10.12.13/29 \n\nso the answer is10.10.12.8\n**Q2.**How many IP addresses will Nmap scan if you provide the following range 10.10.0-255.101-125? \nwe can use the command nmap -sL **10.10.0-255.101-125** \n\nTASK - 4 Discovering Live HostsLet’s revisit the TCP&#x2F;IP layers shown in the figure next. We will leverage the protocols to discover the live hosts. Starting from bottom to top, we can use:\n\nARP from Link Layer\nICMP from Network Layer\nTCP from Transport Layer\nUDP from Transport Layer\n\n\nBefore we discuss how scanners can use each in detail, we will briefly review these four protocols. ARP has one purpose: sending a frame to the broadcast address on the network segment and asking the computer with a specific IP address to respond by providing its MAC (hardware) address.\nICMP has many types. ICMP ping uses Type 8 (Echo) and Type 0 (Echo Reply).\nIf you want to ping a system on the same subnet, an ARP query should precede the ICMP Echo.\nAlthough TCP and UDP are transport layers, for network scanning purposes, a scanner can send a specially-crafted packet to common TCP or UDP ports to check whether the target will respond. This method is efficient, especially when ICMP Echo is blocked.\nIf you have closed the network simulator, click on the “View Site” button in Task 2 to display it again.\nAnswer the questions below\nSend a packet with the following:\n\nFrom computer1\nTo computer3\nPacket Type: “Ping Request”\n\nWhat is the type of packet that computer1 sent before the ping?\nAnswer: ARP REQUEST\nWhat is the type of packet that computer1 received before being able to send the ping?\nAnswer: ARP RESPONSE\nHow many computers responded to the ping request?\nAnswer: 1\nSend a packet with the following:\n\nFrom computer2\nTo computer5\nPacket Type: “Ping Request”\n\nWhat is the name of the first device that responded to the first ARP Request?\nAnswer: Router\nWhat is the name of the first device that responded to the second ARP Request?\nAnswer: Computer5\n\nTASK 5 - Nmap Host Discovery Using ARPHow would you know which hosts are up and running? It is essential to avoid wasting our time port-scanning an offline host or an IP address not in use. There are various ways to discover online hosts. When no host discovery options are provided, Nmap follows the following approaches to discover live hosts:\n\nWhen a privileged user tries to scan targets on a local network (Ethernet), Nmap uses ARP requests. A privileged user is root or a user who belongs to sudoers and can run sudo.\nWhen a privileged user tries to scan targets outside the local network, Nmap uses ICMP echo requests, TCP ACK (Acknowledge) to port 80, TCP SYN (Synchronize) to port 443, and ICMP timestamp request.\nWhen an unprivileged user tries to scan targets outside the local network, Nmap resorts to a TCP 3-way handshake by sending SYN packets to ports 80 and 443.\n\nNmap, by default, uses a ping scan to find live hosts, then proceeds to scan live hosts only. If you want to use Nmap to discover online hosts without port-scanning the live systems, you can issue nmap -sn TARGETS. Let’s dig deeper into the different techniques used.\nARP scan is possible only if you are on the same subnet as the target systems. On an Ethernet (802.3) and WiFi (802.11), you need to know the MAC address of any system before you can communicate with it. The MAC address is necessary for the link-layer header; the header contains the source MAC address and the destination MAC address among other fields. To get the MAC address, the OS sends an ARP query. A host that replies to ARP queries is up. The ARP query only works if the target is on the same subnet as yourself, i.e., on the same Ethernet&#x2F;WiFi. You should expect to see many ARP queries generated during a Nmap scan of a local network. If you want Nmap only to perform an ARP scan without port-scanning, you can use nmap -PR -sn TARGETS, where -PR indicates that you only want an ARP scan. The following example shows Nmap using ARP for host discovery without any port scanning. We run nmap -PR -sn MACHINE_IP/24 to discover all the live systems on the same subnet as our target machine.\nPentester Terminal\n1234567891011121314pentester@TryHackMe$ sudo nmap -PR -sn 10.10.210.6/24Starting Nmap 7.60 ( https://nmap.org ) at 2021-09-02 07:12 BSTNmap scan report for ip-10-10-210-75.eu-west-1.compute.internal (10.10.210.75)Host is up (0.00013s latency).MAC Address: 02:83:75:3A:F2:89 (Unknown)Nmap scan report for ip-10-10-210-100.eu-west-1.compute.internal (10.10.210.100)Host is up (-0.100s latency).MAC Address: 02:63:D0:1B:2D:CD (Unknown)Nmap scan report for ip-10-10-210-165.eu-west-1.compute.internal (10.10.210.165)Host is up (0.00025s latency).MAC Address: 02:59:79:4F:17:B7 (Unknown)Nmap scan report for ip-10-10-210-6.eu-west-1.compute.internal (10.10.210.6)Host is up.Nmap done: 256 IP addresses (4 hosts up) scanned in 3.12 secondsIn this case, the AttackBox had the IP address 10.10.210.6, and it used ARP requests to discover the live hosts on the same subnet. ARP scan works, as shown in the figure below. Nmap sends ARP requests to all the target computers, and those online should send an ARP reply back.\n\nIf we look at the packets generated using a tool such as tcpdump or Wireshark, we will see network traffic similar to the figure below. In the figure below, Wireshark displays the source MAC address, destination MAC address, protocol, and query related to each ARP request. The source address is the MAC address of our AttackBox, while the destination is the broadcast address as we don’t know the MAC address of the target. However, we see the target’s IP address, which appears in the Info column. In the figure, we can see that we are requesting the MAC addresses of all the IP addresses on the subnet, starting with 10.10.210.1. The host with the IP address we are asking about will send an ARP reply with its MAC address, and that’s how we will know that it is online.\nTalking about ARP scans, we should mention a scanner built around ARP queries: arp-scan; it provides many options to customize your scan. Visit the arp-scan wiki for detailed information. One popular choice is arp-scan –localnet or simply arp-scan -l. This command will send ARP queries to all valid IP addresses on your local networks. Moreover, if your system has more than one interface and you are interested in discovering the live hosts on one of them, you can specify the interface using -I. For instance, sudo arp-scan -I eth0 -l will send ARP queries for all valid IP addresses on the eth0 interface.\nNote that arp-scan is not installed on the AttackBox; however, it can be installed using apt install arp-scan.\nIn the example below, we scanned the subnet of the AttackBox using arp-scan ATTACKBOX_IP&#x2F;24. Since we ran this scan at a time frame close to the previous one nmap -PR -sn ATTACKBOX_IP&#x2F;24, we obtained the same three live targets.\n123456789pentester@TryHackMe$ sudo arp-scan 10.10.210.6/24Interface: eth0, datalink type: EN10MB (Ethernet)WARNING: host part of 10.10.210.6/24 is non-zeroStarting arp-scan 1.9 with 256 hosts (http://www.nta-monitor.com/tools/arp-scan/)10.10.210.75\t02:83:75:3a:f2:89\t(Unknown)10.10.210.100\t02:63:d0:1b:2d:cd\t(Unknown)10.10.210.165\t02:59:79:4F:17:B7\t(Unknown)4 packets received by filter, 0 packets dropped by kernelEnding arp-scan 1.9: 256 hosts scanned in 2.726 seconds (93.91 hosts/sec). 3 responded\nSimilarly, the command arp-scan will generate many ARP queries that we can see using tcpdump, Wireshark, or a similar tool. We can notice that the packet capture for arp-scan and nmap -PR -sn yield similar traffic patterns. Below is the Wireshark output.\n\nIf you have closed the network simulator, click on the “Visit Site” button in Task 2 to display it again.\nAnswer the questions below:\nWe will be sending broadcast ARP Requests packets with the following options:\n\nFrom computer1\nTo computer1 (to indicate it is broadcast)\nPacket Type: “ARP Request”\nData: try all the possible eight devices (other than computer1) in the network: computer2, computer3, computer4, computer5, computer6, switch1, switch2, and router.\n\nHow many devices are you able to discover using ARP requests?\n3\n\nTASK 6 - NMAP HOST DISCOVERY USING ICMPWe can ping every IP address on a target network and see who would respond to our ping (ICMP Type 8&#x2F;Echo) requests with a ping reply (ICMP Type 0). Simple, isn’t it? Although this would be the most straightforward approach, it is not always reliable. Many firewalls block ICMP echo; new versions of MS Windows are configured with a host firewall that blocks ICMP echo requests by default. Remember that an ARP query will precede the ICMP request if your target is on the same subnet.\nTo use ICMP echo request to discover live hosts, add the option -PE. (Remember to add -sn if you don’t want to follow that with a port scan.) As shown in the following figure, an ICMP echo scan works by sending an ICMP echo request and expects the target to reply with an ICMP echo reply if it is online.\n\nIn the example below, we scanned the target’s subnet using nmap -PE -sn MACHINE_IP/24. This scan will send ICMP echo packets to every IP address on the subnet. Again, we expect live hosts to reply; however, it is wise to remember that many firewalls block ICMP. The output below shows the result of scanning the virtual machine’s class C subnet using sudo nmap -PE -sn MACHINE_IP/24 from the AttackBox.\n12345678910111213141516171819202122232425262728**Pentester Terminal:**pentester@TryHackMe$ sudo nmap -PE -sn 10.10.68.220/24Starting Nmap 7.60 ( https://nmap.org ) at 2021-09-02 10:16 BSTNmap scan report for ip-10-10-68-50.eu-west-1.compute.internal (10.10.68.50)Host is up (0.00017s latency).MAC Address: 02:95:36:71:5B:87 (Unknown)Nmap scan report for ip-10-10-68-52.eu-west-1.compute.internal (10.10.68.52)Host is up (0.00017s latency).MAC Address: 02:48:E8:BF:78:E7 (Unknown)Nmap scan report for ip-10-10-68-77.eu-west-1.compute.internal (10.10.68.77)Host is up (-0.100s latency).MAC Address: 02:0F:0A:1D:76:35 (Unknown)Nmap scan report for ip-10-10-68-110.eu-west-1.compute.internal (10.10.68.110)Host is up (-0.10s latency).MAC Address: 02:6B:50:E9:C2:91 (Unknown)Nmap scan report for ip-10-10-68-140.eu-west-1.compute.internal (10.10.68.140)Host is up (0.00021s latency).MAC Address: 02:58:59:63:0B:6B (Unknown)Nmap scan report for ip-10-10-68-142.eu-west-1.compute.internal (10.10.68.142)Host is up (0.00016s latency).MAC Address: 02:C6:41:51:0A:0F (Unknown)Nmap scan report for ip-10-10-68-220.eu-west-1.compute.internal (10.10.68.220)Host is up (0.00026s latency).MAC Address: 02:25:3F:DB:EE:0B (Unknown)Nmap scan report for ip-10-10-68-222.eu-west-1.compute.internal (10.10.68.222)Host is up (0.00025s latency).MAC Address: 02:28:B1:2E:B0:1B (Unknown)Nmap done: 256 IP addresses (8 hosts up) scanned in 2.11 seconds\n\nThe scan output shows that eight hosts are up; moreover, it shows their MAC addresses. Generally speaking, we don’t expect to learn the MAC addresses of the targets unless they are on the same subnet as our system. The output above indicates that Nmap didn’t need to send ICMP packets as it confirmed that these hosts are up based on the ARP responses it received.\nWe will repeat the scan above; however, this time, we will scan from a system that belongs to a different subnet. The results are similar but without the MAC addresses.\n12345678910111213141516171819Pentester Terminal pentester@TryHackMe$ sudo nmap -PE -sn 10.10.68.220/24Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 12:16 EESTNmap scan report for 10.10.68.50Host is up (0.12s latency).Nmap scan report for 10.10.68.52Host is up (0.12s latency).Nmap scan report for 10.10.68.77Host is up (0.11s latency).Nmap scan report for 10.10.68.110Host is up (0.11s latency).Nmap scan report for 10.10.68.140Host is up (0.11s latency).Nmap scan report for 10.10.68.142Host is up (0.11s latency).Nmap scan report for 10.10.68.220Host is up (0.11s latency).Nmap scan report for 10.10.68.222Host is up (0.11s latency).Nmap done: 256 IP addresses (8 hosts up) scanned in 8.26 second\n\nIf you look at the network packets using a tool like Wireshark, you will see something similar to the image below. You can see that we have one source IP address on a different subnet than that of the destination subnet, sending ICMP echo requests to all the IP addresses in the target subnet to see which one will reply.\n\nBecause ICMP echo requests tend to be blocked, you might also consider ICMP Timestamp or ICMP Address Mask requests to tell if a system is online. Nmap uses timestamp request (ICMP Type 13) and checks whether it will get a Timestamp reply (ICMP Type 14). Adding the -PP option tells Nmap to use ICMP timestamp requests. As shown in the figure below, you expect live hosts to reply.\n\nIn the following example, we run nmap -PP -sn MACHINE_IP/24 to discover the online computers on the target machine subnet.\nPentester Terminal\n12345678910111213141516171819pentester@TryHackMe$ sudo nmap -PP -sn 10.10.68.220/24Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 12:06 EESTNmap scan report for 10.10.68.50Host is up (0.13s latency).Nmap scan report for 10.10.68.52Host is up (0.25s latency).Nmap scan report for 10.10.68.77Host is up (0.14s latency).Nmap scan report for 10.10.68.110Host is up (0.14s latency).Nmap scan report for 10.10.68.140Host is up (0.15s latency).Nmap scan report for 10.10.68.209Host is up (0.14s latency).Nmap scan report for 10.10.68.220Host is up (0.14s latency).Nmap scan report for 10.10.68.222Host is up (0.14s latency).Nmap done: 256 IP addresses (8 hosts up) scanned in 10.93 seconds\n\nSimilar to the previous ICMP scan, this scan will send many ICMP timestamp requests to every valid IP address in the target subnet. In the Wireshark screenshot below, you can see one source IP address sending ICMP packets to every possible IP address to discover online hosts.\n\nSimilarly, Nmap uses address mask queries (ICMP Type 17) and checks whether it gets an address mask reply (ICMP Type 18). This scan can be enabled with the option -PM. As shown in the figure below, live hosts are expected to reply to ICMP address mask requests.\n\nIn an attempt to discover live hosts using ICMP address mask queries, we run the command nmap -PM -sn MACHINE_IP/24. Although, based on earlier scans, we know that at least eight hosts are up, this scan returned none. The reason is that the target system or a firewall on the route is blocking this type of ICMP packet. Therefore, it is essential to learn multiple approaches to achieve the same result. If one type of packet is being blocked, we can always choose another to discover the target network and services.\nPentester Terminal\n123pentester@TryHackMe$ sudo nmap -PM -sn 10.10.68.220/24Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 12:13 EESTNmap done: 256 IP addresses (0 hosts up) scanned in 52.17 seconds\n\n\nAlthough we didn’t get any reply and could not figure out which hosts are online, it is essential to note that this scan sent ICMP address mask requests to every valid IP address and waited for a reply. Each ICMP request was sent twice, as we can see in the screenshot below.\n\nAnswer the questions below\nWhat is the option required to tell Nmap to use ICMP Timestamp to discover live hosts?\nCorrect Answer : -pp\nWhat is the option required to tell Nmap to use ICMP Address Mask to discover live hosts?\nCorrect Answer : -PN\nWhat is the option required to tell Nmap to use ICMP Echo to discover live hosts?\nCorrect Answer : -PE\nTASK 7 - Nmap Host Discovery Using TCP and UDPTCP SYN Ping\nWe can send a packet with the SYN (Synchronize) flag set to a TCP port, 80 by default, and wait for a response. An open port should reply with a SYN&#x2F;ACK (Acknowledge); a closed port would result in an RST (Reset). In this case, we only check whether we will get any response to infer whether the host is up. The specific state of the port is not significant here. The figure below is a reminder of how a TCP 3-way handshake usually works.\n\nIf you want Nmap to use TCP SYN ping, you can do so via the option -PS followed by the port number, range, list, or a combination of them. For example, -PS21 will target port 21, while -PS21-25 will target ports 21, 22, 23, 24, and 25. Finally -PS80,443,8080 will target the three ports 80, 443, and 8080.\nPrivileged users (root and sudoers) can send TCP SYN packets and don’t need to complete the TCP 3-way handshake even if the port is open, as shown in the figure below. Unprivileged users have no choice but to complete the 3-way handshake if the port is open.\n\nWe will run nmap -PS -sn MACHINE_IP/24 to scan the target VM subnet. As we can see in the output below, we were able to discover five hosts.\nPentester Terminal\n123456789101112pentester@TryHackMe$ sudo nmap -PS -sn 10.10.68.220/24Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 13:45 EESTNmap scan report for 10.10.68.52Host is up (0.10s latency).Nmap scan report for 10.10.68.121Host is up (0.16s latency).Nmap scan report for 10.10.68.125Host is up (0.089s latency).Nmap scan report for 10.10.68.134Host is up (0.13s latency).Nmap scan report for 10.10.68.220Host is up (0.11s latency).Nmap done: 256 IP addresses (5 hosts up) scanned in 17.38 seconds\n\nLet’s take a closer look at what happened behind the scenes by looking at the network traffic on Wireshark in the figure below. Technically speaking, since we didn’t specify any TCP ports to use in the TCP ping scan, Nmap used common ports; in this case, it is TCP port 80. Any service listening on port 80 is expected to reply, indirectly indicating that the host is online.\n\nTCP ACK Ping\nAs you have guessed, this sends a packet with an ACK flag set. You must be running Nmap as a privileged user to be able to accomplish this. If you try it as an unprivileged user, Nmap will attempt a 3-way handshake.\nBy default, port 80 is used. The syntax is similar to TCP SYN ping. -PA should be followed by a port number, range, list, or a combination of them. For example, consider -PA21, -PA21-25 and -PA80,443,8080. If no port is specified, port 80 will be used.\nThe following figure shows that any TCP packet with an ACK flag should get a TCP packet back with an RST flag set. The target responds with the RST flag set because the TCP packet with the ACK flag is not part of any ongoing connection. The expected response is used to detect if the target host is up.\n\nIn this example, we run sudo nmap -PA -sn MACHINE_IP/24 to discover the online hosts on the target’s subnet. We can see that the TCP ACK ping scan detected five hosts as up.\nPentester Terminal\n123456789101112pentester@TryHackMe$ sudo nmap -PA -sn 10.10.68.220/24Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 13:46 EESTNmap scan report for 10.10.68.52Host is up (0.11s latency).Nmap scan report for 10.10.68.121Host is up (0.12s latency).Nmap scan report for 10.10.68.125Host is up (0.10s latency).Nmap scan report for 10.10.68.134Host is up (0.10s latency).Nmap scan report for 10.10.68.220Host is up (0.10s latency).Nmap done: 256 IP addresses (5 hosts up) scanned in 29.89 seconds\n\nIf we peek at the network traffic as shown in the figure below, we will discover many packets with the ACK flag set and sent to port 80 of the target systems. Nmap sends each packet twice. The systems that don’t respond are offline or inaccessible.\n\nUDP Ping\nFinally, we can use UDP to discover if the host is online. Contrary to TCP SYN ping, sending a UDP packet to an open port is not expected to lead to any reply. However, if we send a UDP packet to a closed UDP port, we expect to get an ICMP port unreachable packet; this indicates that the target system is up and available.\nIn the following figure, we see a UDP packet sent to an open UDP port and not triggering any response. However, sending a UDP packet to any closed UDP port can trigger a response indirectly indicating that the target is online.\n\n\nThe syntax to specify the ports is similar to that of TCP SYN ping and TCP ACK ping; Nmap uses -PU for UDP ping. In the following example, we use a UDP scan, and we discover five live hosts.\nPentester Terminal\n123456789101112pentester@TryHackMe$ sudo nmap -PU -sn 10.10.68.220/24Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 13:45 EESTNmap scan report for 10.10.68.52Host is up (0.10s latency).Nmap scan report for 10.10.68.121Host is up (0.10s latency).Nmap scan report for 10.10.68.125Host is up (0.14s latency).Nmap scan report for 10.10.68.134Host is up (0.096s latency).Nmap scan report for 10.10.68.220Host is up (0.11s latency).Nmap done: 256 IP addresses (5 hosts up) scanned in 9.20 second\nLet’s inspect the UDP packets generated. In the following Wireshark screenshot, we notice Nmap sending UDP packets to UDP ports that are most likely closed. The image below shows that Nmap uses an uncommon UDP port to trigger an ICMP destination unreachable (port unreachable) error.\n\nMasscan\nOn a side note, Masscan uses a similar approach to discover the available systems. However, to finish its network scan quickly, Masscan is quite aggressive with the rate of packets it generates. The syntax is quite similar: -p can be followed by a port number, list, or range. Consider the following examples:\n\nmasscan MACHINE_IP/24 -p443\nmasscan MACHINE_IP/24 -p80,443\nmasscan MACHINE_IP/24 -p22-25\nmasscan MACHINE_IP/24 ‐‐top-ports 100\n\nMasscan is not installed on the AttackBox; however, it can be installed using apt install masscan.\nAnswer the questions below\nWhich TCP ping scan does not require a privileged account?\nTCP SYN PING\nWhich TCP ping scan requires a privileged account?\nTCP ACK PING\nWhat option do you need to add to Nmap to run a TCP SYN ping scan on the telnet port?\n-ps23\nTASK 8 - USING REVERSE DNS LOOKUPNmap’s default behaviour is to use reverse-DNS online hosts. Because the hostnames can reveal a lot, this can be a helpful step. However, if you don’t want to send such DNS queries, you use -n to skip this step.\nBy default, Nmap will look up online hosts; however, you can use the option -R to query the DNS server even for offline hosts. If you want to use a specific DNS server, you can add the --dns-servers DNS_SERVER option.\nAnswer the questions below\nWe want Nmap to issue a reverse DNS lookup for all the possibles hosts on a subnet, hoping to get some insights from the names. What option should we add?\nCorrect Answer : -R\n\nSUMMARY OF THE ROOM\nYou have learned how ARP, ICMP, TCP, and UDP can detect live hosts by completing this room. Any response from a host is an indication that it is online. Below is a quick summary of the command-line options for Nmap that we have covered.\n\n\n\nScan Type\nExample Command\n\n\n\nARP Scan\nsudo nmap -PR -sn MACHINE_IP&#x2F;24\n\n\nICMP Echo Scan\nsudo nmap -PE -sn MACHINE_IP&#x2F;24\n\n\nICMP Timestamp Scan\nsudo nmap -PP -sn MACHINE_IP&#x2F;24\n\n\nICMP Address Mask Scan\nsudo nmap -PM -sn MACHINE_IP&#x2F;24\n\n\nTCP SYN Ping Scan\nsudo nmap -PS22,80,443 -sn MACHINE_IP&#x2F;30\n\n\nTCP ACK Ping Scan\nsudo nmap -PA22,80,443 -sn MACHINE_IP&#x2F;30\n\n\nUDP Ping Scan\nsudo nmap -PU53,161,162 -sn MACHINE_IP&#x2F;30\n\n\nRemember to add -sn if you are only interested in host discovery without port-scanning. Omitting -sn will let Nmap default to port-scanning the live hosts.\n\n\n\nOption\nPurpose\n\n\n\n-n\nno DNS lookup\n\n\n-R\nreverse-DNS lookup for all hosts\n\n\n-sn\nhost discovery only\n\n\nThank YouSatvik\n","slug":"Live-Host-Discovery","date":"2024-05-16T13:59:01.000Z","categories_index":"cybersecurity,THM,NMAP","tags_index":"tryhackme,nmap,information-gathering","author_index":"Satvik"},{"id":"58abb440477d90f4f081be1f94565844","title":"Basic Port Scan - NMAP","content":"Nmap Basic Port ScansINTRODUCTIONThe next step would be checking which ports are open and listening and which ports are closed. Therefore, in this room and the next one, we focus on port scanning and the different types of port scans used by nmap. This room explains:\n\nTCP connect port scan\nTCP SYN port scan\nUDP port scan\n\nMoreover, we discuss the different options to specify the ports, the scan rate, and the number of parallel probes.\nTASK - 2 TCP and UDP PORTSIn the same sense that an IP address specifies a host on a network among many others, a TCP port or UDP port is used to identify a network service running on that host. A server provides the network service, and it adheres to a specific network protocol. Examples include providing time, responding to DNS queries, and serving web pages. A port is usually linked to a service using that specific port number. For instance, an HTTP server would bind to TCP port 80 by default; moreover, if the HTTP server supports SSL&#x2F;TLS, it would listen on TCP port 443. (TCP ports 80 and 443 are the default ports for HTTP and HTTPS; however, the webserver administrator might choose other port numbers if necessary.) Furthermore, no more than one service can listen on any TCP or UDP port (on the same IP address).\nAt the risk of oversimplification, we can classify ports in two states:\n\nOpen port indicates that there is some service listening on that port.\nClosed port indicates that there is no service listening on that port.\n\nHowever, in practical situations, we need to consider the impact of firewalls. For instance, a port might be open, but a firewall might be blocking the packets. Therefore, Nmap considers the following six states:\n\nOpen: indicates that a service is listening on the specified port.\nClosed: indicates that no service is listening on the specified port, although the port is accessible. By accessible, we mean that it is reachable and is not blocked by a firewall or other security appliances&#x2F;programs.\nFiltered: means that Nmap cannot determine if the port is open or closed because the port is not accessible. This state is usually due to a firewall preventing Nmap from reaching that port. Nmap’s packets may be blocked from reaching the port; alternatively, the responses are blocked from reaching Nmap’s host.\nUnfiltered: means that Nmap cannot determine if the port is open or closed, although the port is accessible. This state is encountered when using an ACK scan -sA.\nOpen|Filtered: This means that Nmap cannot determine whether the port is open or filtered.\nClosed|Filtered: This means that Nmap cannot decide whether a port is closed or filtered.\n\nANSWERS\nWhich service uses UDP port 53 by default?\n\nCorrect Answer: DNS\n\n\nWhich service uses TCP port 22 by default?\n\nCorrect Answer: SSH\n\n\nHow many port states does Nmap consider?\n\nCorrect Answer: 6\n\n\nWhich port state is the most interesting to discover as a pentester?\n\nCorrect Answer: Open\n\n\n\nTASK 3 - TCP FLAGSNmap supports different types of TCP port scans. To understand the difference between these port scans, we need to review the TCP header. The TCP header is the first 24 bytes of a TCP segment. The following figure shows the TCP header as defined in RFC 793. This figure looks sophisticated at first; however, it is pretty simple to understand. In the first row, we have the source TCP port number and the destination port number. We can see that the port number is allocated 16 bits (2 bytes). In the second and third rows, we have the sequence number and the acknowledgment number. Each row has 32 bits (4 bytes) allocated, with six rows total, making up 24 bytes.\nIn particular, we need to focus on the flags that Nmap can set or unset. We have highlighted the TCP flags in red. Setting a flag bit means setting its value to 1. From left to right, the TCP header flags are:\n\nURG: Urgent flag indicates that the urgent pointer filed is significant. The urgent pointer indicates that the incoming data is urgent, and that a TCP segment with the URG flag set is processed immediately without consideration of having to wait on previously sent TCP segments.\nACK: Acknowledgment flag indicates that the acknowledgment number is significant. It is used to acknowledge the receipt of a TCP segment.\nPSH: Push flag asking TCP to pass the data to the application promptly.\nRST: Reset flag is used to reset the connection. Another device, such as a firewall, might send it to tear a TCP connection. This flag is also used when data is sent to a host and there is no service on the receiving end to answer.\nSYN: Synchronize flag is used to initiate a TCP 3-way handshake and synchronize sequence numbers with the other host. The sequence number should be set randomly during TCP connection establishment.\nFIN: The sender has no more data to send.\n\nANSWERS\nWhat 3 letters represent the Reset flag?\n\nCorrect Answer: RST\n\n\nWhich flag needs to be set when you initiate a TCP connection (first packet of TCP 3-way handshake)?\n\nCorrect Answer: SYN\n\n\n\nTASK 4 - TCP CONNECT SCANTCP connect scan works by completing the TCP 3-way handshake. In standard TCP connection establishment, the client sends a TCP packet with SYN flag set, and the server responds with SYN&#x2F;ACK if the port is open; finally, the client completes the 3-way handshake by sending an ACK.\nWe are interested in learning whether the TCP port is open, not establishing a TCP connection. Hence the connection is torn as soon as its state is confirmed by sending a RST&#x2F;ACK. You can choose to run TCP connect scan using -sT.\nIt is important to note that if you are not a privileged user (root or sudoer), a TCP connect scan is the only possible option to discover open TCP ports.\nQuestion:\nLaunch the VM. Open the AttackBox and execute nmap -sT 10.10.23.101 via the terminal. A new service has been installed on this VM since our last scan. Which port number was closed in the scan above but is now open on this target VM? \n\nAnswer: 110\n\nCommand: nmap -sT 10.10.23.101\nNew service: POP3\n\n\nTASK 5 - TCP SYN SCANUnprivileged users are limited to connect scan. However, the default scan mode is SYN scan, and it requires a privileged (root or sudoer) user to run it. SYN scan does not need to complete the TCP 3-way handshake; instead, it tears down the connection once it receives a response from the server. Because we didn’t establish a TCP connection, this decreases the chances of the scan being logged. We can select this scan type by using the -sS option.\nQuestions:\nWhat is the new open port?\n\nCorrect Answer: 6667\n\n\nWhat is Nmap’s guess of the service name?\n\nCorrect Answer: irc\n\n\n\nTask 7: Fine-Tuning Scope and PerformanceYou can specify the ports you want to scan instead of the default 1000 ports. Specifying the ports is intuitive by now. Let’s see some examples:\n\nPort list: -p22,80,443 will scan ports 22, 80, and 443.\nPort range: -p1-1023 will scan all ports between 1 and 1023 inclusive, while -p20-25 will scan ports between 20 and 25 inclusive.\nYou can request the scan of all ports by using -p-, which will scan all 65535 ports. If you want to scan the most common 100 ports, add -F. Using --top-ports 10 will check the ten most common ports.\n\nYou can control the scan timing using -T&lt;0-5&gt;. -T0 is the slowest (paranoid), while -T5 is the fastest. According to the Nmap manual page, there are six templates:\n\nParanoid (0)\nSneaky (1)\nPolite (2)\nNormal (3)\nAggressive (4)\nInsane (5)\n\nTo avoid IDS alerts, you might consider -T0 or -T1. For instance, -T0 scans one port at a time and waits 5 minutes between sending each probe. If you don’t specify any timing, Nmap uses normal -T3. Note that -T5 is the most aggressive in terms of speed; however, this can affect the accuracy of the scan results due to the increased likelihood of packet loss. Note that -T4 is often used during CTFs and when learning to scan on practice targets, whereas -T1 is often used during real engagements where stealth is more important.\nAlternatively, you can choose to control the packet rate using --min-rate &lt;number&gt; and --max-rate &lt;number&gt;. For example, --max-rate 10 or --max-rate=10 ensures that your scanner is not sending more than ten packets per second.\nMoreover, you can control probing parallelization using --min-parallelism &lt;numprobes&gt; and --max-parallelism &lt;numprobes&gt;. Nmap probes the targets to discover which hosts are live and which ports are open; probing parallelization specifies the number of such probes that can be run in parallel. For instance, --min-parallelism=512 pushes Nmap to maintain at least 512 probes in parallel; these 512 probes are related to host discovery and open ports.\nTASK 8 - SUMMARYThis room covered three types of scans:\n\nTCP Connect\nTCP SYN\nUDP\n\nThese scan types should get you started discovering running TCP and UDP services on a target host.\nDONE\nTHANK YOU,Satvik Shetty\n","slug":"Basic-Port-Scan-THM","date":"2024-05-16T10:05:28.000Z","categories_index":"cybersecurity,THM","tags_index":"tryhackme,nmap,information-gathering","author_index":"Satvik"},{"id":"df002c45b5a83b11244a8755ec495303","title":"Beginner Resources 2024","content":"Online Tools and ResourcesIP and DNS Leak Testing\nipleak.net\ndiafygi.github.io&#x2F;webrtc-ips\ndnsleaktest.com\n\nTor Check 🧅\n5deqglhxcoy3gbx6.onion\ntmkloc6vhxos3nde.onion\n\nSMS 📩\nreceive-sms-online.info\nreceive-sms-now.com\nreceivesmsonline.net\n\nFake Identity 🙃\nfakena.me\nnames.igopaygo.com&#x2F;people&#x2F;fake_person\nfakenamegenerator.com\n\nNetwork Online Tools 🌐\nyougetsignal.com\ndnswatch.info\nnirsoft.net&#x2F;countryip\ntcpiputils.com\nbgp.he.net\nsockets.com&#x2F;services.htm\nservices.ce3c.be&#x2F;ciprg\ncoffer.com&#x2F;mac_find\n\nVulnerabilities Database 🎯\ncve.mitre.org&#x2F;cve\ncvedetails.com\nosvdb.org\nkb.cert.org&#x2F;vuls\nsecunia.com&#x2F;community&#x2F;advisories&#x2F;search\nsecurityfocus.com&#x2F;bid\nlwn.net&#x2F;Vulnerabilities\ndenimgroup.com&#x2F;resources-threadfix\nvulnerability-lab.com\nsecdocs.org\nnvd.nist.gov\n\nExploits Database 💥\nexploit-db.com\nintelligentexploit.com\nshodanhq.com\npacketstormsecurity.com\n\n","slug":"Resources-2024-Beginners","date":"2024-05-15T19:12:11.000Z","categories_index":"","tags_index":"resources,cybersecurity,hacking","author_index":"Satvik"}]